<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Ian & Lala — Income / Expense / Transfers / Investment / Giving (v5)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --pad: 16px; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background: #f7f7f8; color: #111; }
    header { padding: 24px; background: white; border-bottom: 1px solid #e5e5e7; position: sticky; top: 0; z-index: 10; }
    h1 { margin: 0; font-size: 20px; }
    main { max-width: 1000px; margin: 24px auto; padding: 0 16px 48px; }
    .card { background: white; border: 1px solid #e5e5e7; border-radius: 12px; padding: 20px; box-shadow: 0 1px 2px rgba(0,0,0,0.03); }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .group { margin: 12px 0; }
    label { display: block; margin-bottom: 6px; font-weight: 600; }
    input[type="text"], input[type="number"], select, textarea {
      width: 100%; padding: 10px 12px; border: 1px solid #d0d5dd; border-radius: 10px; background: #fff; font: inherit;
    }
    textarea { min-height: 80px; resize: vertical; }
    .hidden { display: none !important; }
    .muted { color: #667085; font-size: 13px; }
    button {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 10px 16px; border-radius: 10px; border: 1px solid #1f6feb;
      background: #2563eb; color: #fff; font-weight: 600; cursor: pointer;
    }
    button.secondary { background: #fff; color: #111; border-color: #d0d5dd; }
    .banner { padding: 12px 14px; border-radius: 10px; margin: 12px 0; }
    .success { background: #ecfdf5; color: #065f46; border: 1px solid #a7f3d0; }
    .error { background: #fef2f2; color: #b91c1c; border: 1px solid #fecaca; }
    .divider { height: 1px; background: #eee; margin: 16px 0; }
    details { margin-top: 12px; }
  </style>
</head>
<body>
  <header>
    <h1>Income / Expense / Transfers / Investment / Giving</h1>
    <div class="muted">Who → Category → adaptive questions with person-specific accounts.</div>
  </header>

  <main>
    <section class="card">
      <form id="trackerForm" novalidate>
        <!-- 1) Who -->
        <div class="group">
          <label for="who">1) Who are you?</label>
          <select id="who" name="who" required>
            <option value="">-- Select --</option>
            <option value="Lala">Lala</option>
            <option value="Ian">Ian</option>
          </select>
        </div>

        <!-- 2) Category -->
        <div class="group">
          <label for="category">2) Category</label>
          <select id="category" name="category" required>
            <option value="">-- Select --</option>
            <option value="income">Income</option>
            <option value="expense">Expense</option>
            <option value="transfer">Transfers</option>
            <option value="investment">Investment</option>
            <option value="giving">Giving</option>
          </select>
        </div>

        <!-- INCOME PATH -->
        <div id="incomeGroup" class="hidden">
          <div class="divider"></div>
          <h3>Income</h3>
          <div class="row">
            <div class="group">
              <label for="incomeType">3) Income Type</label>
              <select id="incomeType" name="income_type">
                <option value="">-- Select --</option>
                <option>Salary</option>
                <option>Commission</option>
                <option>Extra Fund</option>
                <option>Receivables</option>
              </select>
            </div>
            <div class="group">
              <label for="incomeDest">4) Kept in (Destination)</label>
              <select id="incomeDest" name="income_dest">
                <option value="">-- Select --</option>
              </select>
              <div class="muted">Includes person-specific savings/wallets + Cash.</div>
            </div>
          </div>
          <div class="row">
            <div class="group">
              <label for="incomeAmount">5) Amount (PHP)</label>
              <input type="number" id="incomeAmount" name="income_amount" min="1" inputmode="numeric" />
            </div>
            <div class="group">
              <label for="incomeNote">Note (optional)</label>
              <input type="text" id="incomeNote" name="income_note" placeholder="e.g., client, period, remarks" />
            </div>
          </div>
        </div>

        <!-- EXPENSE PATH -->
        <div id="expenseGroup" class="hidden">
          <div class="divider"></div>
          <h3>Expense</h3>
          <div class="row">
            <div class="group">
              <label for="expenseCategory">3) Expense Category</label>
              <select id="expenseCategory" name="expense_category">
                <option value="">-- Select --</option>
                <option>Mortgage / Housing Loan</option>
                <option>Utilities & Bills</option>
                <option>Car / Transportation</option>
                <option>Debt & Payables</option>
                <option>Food Groceries</option>
                <option>Non-Food Groceries</option>
                <option>Pets</option>
                <option>Medical & Maintenance Medications</option>
                <option>Dining Out / Entertainment</option>
                <option>Clothing & Shopping</option>
                <option>Travel / Leisure Fund</option>
                <option>Socials / Gifts / Small rewards / Minor Emergencies</option>
              </select>
            </div>
            <div class="group">
              <label for="expensePaidFrom">Paid From (Account)</label>
              <select id="expensePaidFrom" name="expense_paid_from">
                <option value="">-- Select --</option>
              </select>
              <div class="muted">Choose a savings/wallet or a credit card under the selected person.</div>
            </div>
          </div>
          <div class="row">
            <div class="group">
              <label for="expenseAmount">Amount (PHP)</label>
              <input type="number" id="expenseAmount" name="expense_amount" min="1" inputmode="numeric" />
            </div>
            <div class="group">
              <label for="expenseNote">Note (optional)</label>
              <input type="text" id="expenseNote" name="expense_note" placeholder="e.g., billing month, merchant, etc." />
            </div>
          </div>
        </div>

        <!-- TRANSFERS PATH -->
        <div id="transferGroup" class="hidden">
          <div class="divider"></div>
          <h3>Transfers</h3>
          <div class="group">
            <label for="transferType">3) What type of Transfer?</label>
            <select id="transferType" name="transfer_type">
              <option value="">-- Select --</option>
              <option value="fund">Fund Transfer</option>
              <option value="investment">Investment</option>
            </select>
          </div>

          <!-- FUND TRANSFER -->
          <div id="fundGroup" class="hidden">
            <div class="row">
              <div class="group">
                <label for="fundFromWho">From — Who?</label>
                <select id="fundFromWho" name="fund_from_who">
                  <option value="">-- Select --</option>
                  <option value="Lala">Lala</option>
                  <option value="Ian">Ian</option>
                </select>
              </div>
              <div class="group">
                <label for="fundFromAccount">From Which Account?</label>
                <select id="fundFromAccount" name="fund_from_account">
                  <option value="">-- Select --</option>
                </select>
              </div>
            </div>

            <div class="row">
              <div class="group">
                <label for="fundToWho">To — Who?</label>
                <select id="fundToWho" name="fund_to_who">
                  <option value="">-- Select --</option>
                  <option value="Lala">Lala</option>
                  <option value="Ian">Ian</option>
                </select>
              </div>
              <div class="group">
                <label for="fundToAccount">To Which Account?</label>
                <select id="fundToAccount" name="fund_to_account">
                  <option value="">-- Select --</option>
                </select>
              </div>
            </div>

            <div class="row">
              <div class="group">
                <label for="fundAmount">Amount (PHP)</label>
                <input type="number" id="fundAmount" name="fund_amount" min="1" inputmode="numeric" />
              </div>
              <div class="group">
                <label for="fundNote">Note (optional)</label>
                <input type="text" id="fundNote" name="fund_note" placeholder="e.g., allowance, reimbursement, pocket-to-pocket, etc." />
              </div>
            </div>
          </div>

          <!-- INVESTMENT (under Transfers) -->
          <div id="investmentSubGroup" class="hidden">
            <div class="row">
              <div class="group">
                <label for="invSubFromWho">From — Who?</label>
                <select id="invSubFromWho" name="invsub_from_who">
                  <option value="">-- Select --</option>
                  <option value="Lala">Lala</option>
                  <option value="Ian">Ian</option>
                </select>
              </div>
              <div class="group">
                <label for="invSubFromAccount">From Which Account?</label>
                <select id="invSubFromAccount" name="invsub_from_account">
                  <option value="">-- Select --</option>
                </select>
              </div>
            </div>

            <div class="row">
              <div class="group">
                <label for="invSubToWho">To — Who?</label>
                <select id="invSubToWho" name="invsub_to_who">
                  <option value="">-- Select --</option>
                  <option value="Lala">Lala</option>
                  <option value="Ian">Ian</option>
                </select>
              </div>
              <div class="group">
                <label for="invSubToAccount">To Which Account?</label>
                <select id="invSubToAccount" name="invsub_to_account">
                  <option value="">-- Select --</option>
                </select>
                <div class="muted">Investment accounts: IBKR, GoTrade, PSE.</div>
              </div>
            </div>
          </div>
        </div>

        <!-- INVESTMENT (Top-level) -->
        <div id="investmentGroup" class="hidden">
          <div class="divider"></div>
          <h3>Investment</h3>
          <div class="row">
            <div class="group">
              <label for="invFromWho">From — Who?</label>
              <select id="invFromWho" name="inv_from_who">
                <option value="">-- Select --</option>
                <option value="Lala">Lala</option>
                <option value="Ian">Ian</option>
              </select>
            </div>
            <div class="group">
              <label for="invFromAccount">From Which Account?</label>
              <select id="invFromAccount" name="inv_from_account">
                <option value="">-- Select --</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div class="group">
              <label for="invToWho">To — Who?</label>
              <select id="invToWho" name="inv_to_who">
                <option value="">-- Select --</option>
                <option value="Lala">Lala</option>
                <option value="Ian">Ian</option>
              </select>
            </div>
            <div class="group">
              <label for="invToAccount">To Which Account?</label>
              <select id="invToAccount" name="inv_to_account">
                <option value="">-- Select --</option>
              </select>
              <div class="muted">Investment accounts: IBKR, GoTrade, PSE.</div>
            </div>
          </div>
        </div>

        <!-- GIVING PATH -->
        <div id="givingGroup" class="hidden">
          <div class="divider"></div>
          <h3>Giving</h3>
          <div class="row">
            <div class="group">
              <label for="givingFromWho">From — Who?</label>
              <select id="givingFromWho" name="giving_from_who">
                <option value="">-- Select --</option>
                <option value="Lala">Lala</option>
                <option value="Ian">Ian</option>
              </select>
            </div>
            <div class="group">
              <label for="givingFromAccount">From Which Account?</label>
              <select id="givingFromAccount" name="giving_from_account">
                <option value="">-- Select --</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div class="group">
              <label for="givingPurpose">For?</label>
              <select id="givingPurpose" name="giving_purpose">
                <option value="">-- Select --</option>
                <option>Tithes</option>
                <option>Donations</option>
                <option>Care Fund</option>
              </select>
            </div>
            <div class="group">
              <label for="givingAmount">Amount (PHP)</label>
              <input type="number" id="givingAmount" name="giving_amount" min="1" inputmode="numeric" />
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <!-- Connection + submit -->
        <div id="status" class="banner hidden"></div>
        <div class="group" style="display:flex; gap:8px; align-items:center;">
          <button type="submit">Submit to Google Sheet</button>
          <button type="button" class="secondary" id="resetBtn">Reset</button>
          <span class="muted">This appends a new row to your Sheet.</span>
        </div>

        <input type="hidden" id="localTimestamp" name="localTimestamp" />
      </form>
    </section>

    <section class="card" style="margin-top:16px;">
      <details open>
        <summary><strong>Connection Settings</strong> (pre-filled)</summary>
        <p class="muted">Your Web App URL is hard-coded below. You can still override it temporarily for testing.</p>
        <div class="row">
          <div class="group">
            <label for="scriptUrl">Web App URL</label>
            <input type="text" id="scriptUrl" value="https://script.google.com/macros/s/AKfycbxVvh2AjGmDeGQXHfizJDbVwfTAp1zAlc7R-_jJnD_llzD7HrbsbUFwCBEZJsNOLach/exec" />
          </div>
          <div class="group">
            <label>&nbsp;</label>
            <button type="button" class="secondary" id="saveScriptUrl">Use this URL</button>
          </div>
        </div>
      </details>
    </section>
  </main>

  <script>
    // ===== CONFIG: Apps Script Web App URL =====
    const DEFAULT_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxVvh2AjGmDeGQXHfizJDbVwfTAp1zAlc7R-_jJnD_llzD7HrbsbUFwCBEZJsNOLach/exec";
    let SCRIPT_URL = DEFAULT_SCRIPT_URL;

    // Allow override via query string or the UI
    const params = new URLSearchParams(location.search);
    if (params.get('script')) SCRIPT_URL = params.get('script');

    document.getElementById('saveScriptUrl').addEventListener('click', () => {
      const val = document.getElementById('scriptUrl').value.trim();
      if (val) {
        SCRIPT_URL = val;
        alert('Saved! Submissions will go to:\n' + SCRIPT_URL);
      } else {
        alert('Please paste a valid Web App URL.');
      }
    });

    // ===== Data definitions =====
    const savings = {
      Lala: [
        'PNB Savings',
        'UB Payroll',
        'BDO Commission',
        'GCASH (Digital pocket)',
        'Paymaya (Digital pocket)',
        'SeaBank (Digital Pocket)',
        'CIMB',
        'UNO Digital',
        'BPI joint',
        'Cash'
      ],
      Ian: [
        'UB Payroll',
        'BDO Commission',
        'GCASH (digital pocket)',
        'BPI individual',
        'PNB Savings',
        'CIMB',
        'BPI joint',
        'Cash'
      ]
    };

    const creditCards = {
      Lala: [
        'PNB Ze-Lo',
        'UB Basic Blue',
        'UB Gold Go Rewards',
        'UB Platinum',
        'BDO Visa Classic'
      ],
      Ian: [
        'BPI Blue',
        'BPI Gold',
        'UB Platinum'
      ]
    };

    const investmentAccounts = ['IBKR','GoTrade','PSE'];

    // ===== DOM refs =====
    const whoEl = document.getElementById('who');
    const categoryEl = document.getElementById('category');

    // Income refs
    const incomeGroup = document.getElementById('incomeGroup');
    const incomeDestEl = document.getElementById('incomeDest');

    // Expense refs
    const expenseGroup = document.getElementById('expenseGroup');
    const expensePaidFromEl = document.getElementById('expensePaidFrom');

    // Transfers refs
    const transferGroup = document.getElementById('transferGroup');
    const transferTypeEl = document.getElementById('transferType');
    const fundGroup = document.getElementById('fundGroup');
    const fundFromWhoEl = document.getElementById('fundFromWho');
    const fundFromAccountEl = document.getElementById('fundFromAccount');
    const fundToWhoEl = document.getElementById('fundToWho');
    const fundToAccountEl = document.getElementById('fundToAccount');
    const investmentSubGroup = document.getElementById('investmentSubGroup');
    const invSubFromWhoEl = document.getElementById('invSubFromWho');
    const invSubFromAccountEl = document.getElementById('invSubFromAccount');
    const invSubToWhoEl = document.getElementById('invSubToWho');
    const invSubToAccountEl = document.getElementById('invSubToAccount');

    // Top-level Investment refs
    const investmentGroup = document.getElementById('investmentGroup');
    const invFromWhoEl = document.getElementById('invFromWho');
    const invFromAccountEl = document.getElementById('invFromAccount');
    const invToWhoEl = document.getElementById('invToWho');
    const invToAccountEl = document.getElementById('invToAccount');

    // Giving refs
    const givingGroup = document.getElementById('givingGroup');
    const givingFromWhoEl = document.getElementById('givingFromWho');
    const givingFromAccountEl = document.getElementById('givingFromAccount');
    const givingPurposeEl = document.getElementById('givingPurpose');
    const givingAmountEl = document.getElementById('givingAmount');

    // Misc
    const statusEl = document.getElementById('status');
    const form = document.getElementById('trackerForm');
    const resetBtn = document.getElementById('resetBtn');

    // ===== Helpers =====
    function clearOptions(sel) {
      while (sel.options.length > 1) sel.remove(1);
    }

    function populateIncomeDest(who) {
      clearOptions(incomeDestEl);
      if (!who) return;
      (savings[who] || []).forEach(acc => {
        const opt = document.createElement('option');
        opt.textContent = acc;
        opt.value = acc;
        incomeDestEl.appendChild(opt);
      });
    }

    function populateExpensePaidFrom(who) {
      clearOptions(expensePaidFromEl);
      if (!who) return;
      const grp1 = document.createElement('optgroup');
      grp1.label = who + ' — Savings & Wallets';
      (savings[who] || []).forEach(acc => {
        const opt = document.createElement('option');
        opt.textContent = acc;
        opt.value = acc;
        grp1.appendChild(opt);
      });
      const grp2 = document.createElement('optgroup');
      grp2.label = who + ' — Credit Cards';
      (creditCards[who] || []).forEach(acc => {
        const opt = document.createElement('option');
        opt.textContent = acc;
        opt.value = acc;
        grp2.appendChild(opt);
      });
      expensePaidFromEl.appendChild(grp1);
      expensePaidFromEl.appendChild(grp2);
    }

    function populateSavingsSelect(sel, who) {
      clearOptions(sel);
      if (!who) return;
      const grp = document.createElement('optgroup');
      grp.label = who + ' — Savings & Wallets';
      (savings[who] || []).forEach(acc => {
        const opt = document.createElement('option');
        opt.textContent = acc;
        opt.value = who + ' — ' + acc;
        grp.appendChild(opt);
      });
      sel.appendChild(grp);
    }

    function populateInvestmentSelect(sel) {
      clearOptions(sel);
      const grp = document.createElement('optgroup');
      grp.label = 'Investment Accounts';
      investmentAccounts.forEach(acc => {
        const opt = document.createElement('option');
        opt.textContent = acc;
        opt.value = acc;
        grp.appendChild(opt);
      });
      sel.appendChild(grp);
    }

    // ===== Show/hide logic =====
    function showOnly(...els) {
      [incomeGroup, expenseGroup, transferGroup, investmentGroup, givingGroup]
        .forEach(el => el.classList.add('hidden'));
      els.forEach(el => el.classList.remove('hidden'));
    }

    function showTransferSub(type) {
      fundGroup.classList.add('hidden');
      investmentSubGroup.classList.add('hidden');
      if (type === 'fund') fundGroup.classList.remove('hidden');
      if (type === 'investment') investmentSubGroup.classList.remove('hidden');
    }

    categoryEl.addEventListener('change', () => {
      const cat = categoryEl.value;
      if (cat === 'income') showOnly(incomeGroup);
      else if (cat === 'expense') showOnly(expenseGroup);
      else if (cat === 'transfer' || cat === 'Transfers') showOnly(transferGroup);
      else if (cat === 'investment') showOnly(investmentGroup);
      else if (cat === 'giving') showOnly(givingGroup);
      else showOnly();
    });

    whoEl.addEventListener('change', () => {
      const who = whoEl.value;
      populateIncomeDest(who);
      populateExpensePaidFrom(who);
    });

    transferTypeEl.addEventListener('change', () => {
      showTransferSub(transferTypeEl.value);
    });

    // Fund listeners
    fundFromWhoEl.addEventListener('change', () => {
      populateSavingsSelect(fundFromAccountEl, fundFromWhoEl.value);
    });
    fundToWhoEl.addEventListener('change', () => {
      populateSavingsSelect(fundToAccountEl, fundToWhoEl.value);
    });

    // Investment under Transfers
    invSubFromWhoEl.addEventListener('change', () => {
      populateSavingsSelect(invSubFromAccountEl, invSubFromWhoEl.value);
    });
    invSubToWhoEl.addEventListener('change', () => {
      populateInvestmentSelect(invSubToAccountEl); // shared list
    });

    // Top-level Investment
    invFromWhoEl.addEventListener('change', () => {
      populateSavingsSelect(invFromAccountEl, invFromWhoEl.value);
    });
    invToWhoEl.addEventListener('change', () => {
      populateInvestmentSelect(invToAccountEl);
    });

    // Giving
    givingFromWhoEl.addEventListener('change', () => {
      populateSavingsSelect(givingFromAccountEl, givingFromWhoEl.value);
    });

    // ===== Status helpers =====
    function setStatus(msg, ok=true) {
      statusEl.textContent = msg;
      statusEl.classList.remove('hidden','error','success');
      statusEl.classList.add(ok ? 'success' : 'error','banner');
    }

    resetBtn.addEventListener('click', () => {
      form.reset();
      showOnly();
      showTransferSub('');
      statusEl.classList.add('hidden');
      clearOptions(incomeDestEl);
      clearOptions(expensePaidFromEl);
      clearOptions(fundFromAccountEl);
      clearOptions(fundToAccountEl);
      clearOptions(invSubFromAccountEl);
      clearOptions(invSubToAccountEl);
      clearOptions(invFromAccountEl);
      clearOptions(invToAccountEl);
      clearOptions(givingFromAccountEl);
    });

    // ===== Submit handler =====
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!SCRIPT_URL) {
        setStatus('Missing Web App URL. Open "Connection Settings" and paste your Apps Script Web App URL.', false);
        return;
      }

      const who = whoEl.value;
      const cat = categoryEl.value;
      if (!who || !cat) {
        setStatus('Please select both "Who" and "Category".', false);
        return;
      }

      // Validate requireds based on path
      const missing = [];
      function req(id) { const el = document.getElementById(id); if (!el || !el.value) missing.push(id); }

      if (cat === 'income') {
        ['incomeType','incomeDest','incomeAmount'].forEach(req);
      } else if (cat === 'expense') {
        ['expenseCategory','expensePaidFrom','expenseAmount'].forEach(req);
      } else if (cat === 'transfer' || cat === 'Transfers') {
        req('transferType');
        if (document.getElementById('transferType').value === 'fund') {
          ['fundFromWho','fundFromAccount','fundToWho','fundToAccount','fundAmount'].forEach(req);
        } else if (document.getElementById('transferType').value === 'investment') {
          ['invSubFromWho','invSubFromAccount','invSubToWho','invSubToAccount'].forEach(req);
        }
      } else if (cat === 'investment') {
        ['invFromWho','invFromAccount','invToWho','invToAccount'].forEach(req);
      } else if (cat === 'giving') {
        ['givingFromWho','givingFromAccount','givingPurpose','givingAmount'].forEach(req);
      }

      if (missing.length) {
        setStatus('Please complete all required fields.', false);
        const first = document.getElementById(missing[0]);
        first && first.focus();
        return;
      }

      document.getElementById('localTimestamp').value = new Date().toISOString();

      const data = Object.fromEntries(new FormData(form).entries());
      data.path = cat;
      data.submitter = who;

      try {
        setStatus('Submitting…');
        await fetch(SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        setStatus('Saved! Entry appended to Google Sheet.', true);
        form.reset();
        showOnly();
        showTransferSub('');
      } catch (err) {
        console.error(err);
        setStatus('Failed to submit. Please check the Web App URL and try again.', false);
      }
    });
  </script>
</body>
</html>
