<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Finance Tracker — Income / Expense / Transfers / Investment / Giving (v7)</title>
  <style>
    * {{ box-sizing: border-box; }}
    body {{ font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background: #f7f7f8; color: #0f172a; }}
    header {{ position: sticky; top: 0; background: #fff; border-bottom: 1px solid #e5e7eb; padding: 16px 20px; z-index: 10; }}
    h1 {{ margin: 0; font-size: 20px; }}
    main {{ max-width: 1000px; margin: 20px auto; padding: 0 16px 40px; }}
    .card {{ background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 18px; box-shadow: 0 1px 2px rgba(0,0,0,.04); }}
    .group {{ margin: 12px 0; }}
    label {{ display: block; font-weight: 600; margin-bottom: 6px; }}
    select, input[type="text"], input[type="number"], textarea {{ width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 10px; background: #fff; font: inherit; }}
    textarea {{ min-height: 80px; }}
    .row {{ display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }}
    .hidden {{ display: none !important; }}
    .divider {{ height: 1px; background: #e5e7eb; margin: 16px 0; }}
    .muted {{ color: #6b7280; font-size: 13px; }}
    button {{ display: inline-flex; align-items: center; gap: 8px; padding: 10px 16px; border-radius: 10px; border: 1px solid #1f6feb; background: #2563eb; color: #fff; font-weight: 700; cursor: pointer; }}
    button.secondary {{ background: #fff; color: #111; border-color: #d1d5db; }}
    .banner {{ padding: 10px 12px; border-radius: 10px; margin-top: 10px; }}
    .success {{ background: #ecfdf5; color: #065f46; border: 1px solid #a7f3d0; }}
    .error {{ background: #fef2f2; color: #991b1b; border: 1px solid #fecaca; }}
  </style>
</head>
<body>
  <header>
    <h1>Finance Tracker (v7)</h1>
    <div class="muted">Who → Category → adaptive questions • Connected to your Google Apps Script</div>
  </header>

  <main>
    <section class="card">
      <form id="trackerForm" novalidate>
        <!-- 1) Who -->
        <div class="group">
          <label for="who">1) Who are you?</label>
          <select id="who" name="who" required>
            <option value="">-- Select --</option>
            <option value="Lala">Lala</option>
            <option value="Ian">Ian</option>
          </select>
        </div>

        <!-- 2) Category -->
        <div class="group">
          <label for="category">2) Category</label>
          <select id="category" name="category" required>
            <option value="">-- Select --</option>
            <option value="income">Income</option>
            <option value="expense">Expense</option>
            <option value="transfers">Transfers</option>
            <option value="investment">Investment</option>
            <option value="giving">Giving</option>
          </select>
        </div>

        <!-- INCOME -->
        <div id="incomeGroup" class="hidden">
          <div class="divider"></div>
          <h3>Income</h3>
          <div class="row">
            <div class="group">
              <label for="incomeType">3) Income Type</label>
              <select id="incomeType" name="income_type">
                <option value="">-- Select --</option>
                <option>Salary</option>
                <option>Commission</option>
                <option>Extra Fund</option>
                <option>Receivables</option>
              </select>
            </div>
            <div class="group">
              <label for="incomeAccount">4) Kept in</label>
              <select id="incomeAccount" name="income_account">
                <option value="">-- Select --</option>
              </select>
              <div class="muted">Savings/Wallets under the selected person, including Cash.</div>
            </div>
          </div>
          <div class="group">
            <label for="incomeAmount">5) Amount (PHP)</label>
            <input type="number" id="incomeAmount" name="income_amount" min="1" inputmode="numeric" />
          </div>
        </div>

        <!-- EXPENSE -->
        <div id="expenseGroup" class="hidden">
          <div class="divider"></div>
          <h3>Expense</h3>
          <div class="row">
            <div class="group">
              <label for="expenseCategory">3) Expense Category</label>
              <select id="expenseCategory" name="expense_category">
                <option value="">-- Select --</option>
                <option>Mortgage / Housing Loan</option>
                <option>Utilities & Bills</option>
                <option>Car / Transportation</option>
                <option>Debt & Payables</option>
                <option>Food Groceries</option>
                <option>Non-Food Groceries</option>
                <option>Pets</option>
                <option>Medical & Maintenance Medications</option>
                <option>Dining Out / Entertainment</option>
                <option>Clothing & Shopping</option>
                <option>Travel / Leisure Fund</option>
                <option>Socials / Gifts / Small rewards / Minor Emergencies</option>
              </select>
            </div>
            <div class="group">
              <label for="expenseFrom">Paid From (Account)</label>
              <select id="expenseFrom" name="expense_from">
                <option value="">-- Select --</option>
              </select>
              <div class="muted">Savings/Wallets or Credit Cards under the selected person.</div>
            </div>
          </div>
          <div class="row">
            <div class="group">
              <label for="expenseAmount">Amount (PHP)</label>
              <input type="number" id="expenseAmount" name="expense_amount" min="1" inputmode="numeric" />
            </div>
            <div class="group">
              <label for="expenseNote">Note</label>
              <input type="text" id="expenseNote" name="expense_note" placeholder="e.g., merchant, billing month" />
            </div>
          </div>
        </div>

        <!-- TRANSFERS -->
        <div id="transfersGroup" class="hidden">
          <div class="divider"></div>
          <h3>Transfers</h3>

          <div class="group">
            <label for="transferType">What type of Transfer?</label>
            <select id="transferType" name="transfer_type">
              <option value="">-- Select --</option>
              <option value="fund">Fund Transfer</option>
              <option value="withdrawal">Withdrawal</option>
            </select>
          </div>

          <div class="row">
            <div class="group">
              <label for="trFromWho">From — Who?</label>
              <select id="trFromWho" name="tr_from_who">
                <option value="">-- Select --</option>
                <option value="Lala">Lala</option>
                <option value="Ian">Ian</option>
              </select>
            </div>
            <div class="group">
              <label for="trFromAccount">From Which Account?</label>
              <select id="trFromAccount" name="tr_from_account">
                <option value="">-- Select --</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div class="group">
              <label for="trToWho">To — Who?</label>
              <select id="trToWho" name="tr_to_who">
                <option value="">-- Select --</option>
                <option value="Lala">Lala</option>
                <option value="Ian">Ian</option>
              </select>
            </div>
            <div class="group">
              <label for="trToAccount">To Which Account?</label>
              <select id="trToAccount" name="tr_to_account">
                <option value="">-- Select --</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div class="group">
              <label for="trAmount">Amount (PHP)</label>
              <input type="number" id="trAmount" name="tr_amount" min="1" inputmode="numeric" />
            </div>
            <div class="group">
              <label for="trNote">Note</label>
              <input type="text" id="trNote" name="tr_note" placeholder="e.g., pocket-to-pocket, cash withdrawal" />
            </div>
          </div>
          <div class="muted">Tip: For Withdrawals, the form will auto-set destination to your Cash.</div>
        </div>

        <!-- INVESTMENT -->
        <div id="investmentGroup" class="hidden">
          <div class="divider"></div>
          <h3>Investment</h3>
          <div class="row">
            <div class="group">
              <label for="invFromWho">From — Who?</label>
              <select id="invFromWho" name="inv_from_who">
                <option value="">-- Select --</option>
                <option value="Lala">Lala</option>
                <option value="Ian">Ian</option>
              </select>
            </div>
            <div class="group">
              <label for="invFromAccount">From Which Account?</label>
              <select id="invFromAccount" name="inv_from_account">
                <option value="">-- Select --</option>
              </select>
            </div>
          </div>
          <div class="group">
            <label for="invToAccount">To Which Account?</label>
            <select id="invToAccount" name="inv_to_account">
              <option value="">-- Select --</option>
            </select>
            <div class="muted">Investment accounts: IBKR, GoTrade, PSE.</div>
          </div>
        </div>

        <!-- GIVING -->
        <div id="givingGroup" class="hidden">
          <div class="divider"></div>
          <h3>Giving</h3>
          <div class="row">
            <div class="group">
              <label for="givingFromWho">From — Who?</label>
              <select id="givingFromWho" name="giving_from_who">
                <option value="">-- Select --</option>
                <option value="Lala">Lala</option>
                <option value="Ian">Ian</option>
              </select>
            </div>
            <div class="group">
              <label for="givingFromAccount">From Which Account?</label>
              <select id="givingFromAccount" name="giving_from_account">
                <option value="">-- Select --</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div class="group">
              <label for="givingPurpose">For?</label>
              <select id="givingPurpose" name="giving_purpose">
                <option value="">-- Select --</option>
                <option>Tithes</option>
                <option>Donations</option>
                <option>Care Fund</option>
              </select>
            </div>
            <div class="group">
              <label for="givingAmount">Amount (PHP)</label>
              <input type="number" id="givingAmount" name="giving_amount" min="1" inputmode="numeric" />
            </div>
          </div>
        </div>

        <div class="divider"></div>
        <div id="status" class="banner hidden"></div>
        <div class="group" style="display:flex; gap:8px; align-items:center;">
          <button type="submit">Submit to Google Sheet</button>
          <button type="button" id="resetBtn" class="secondary">Reset</button>
        </div>

        <input type="hidden" id="localTimestamp" name="localTimestamp" />
      </form>
    </section>
  </main>

  <script>
    // ===== Config =====
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxVvh2AjGmDeGQXHfizJDbVwfTAp1zAlc7R-_jJnD_llzD7HrbsbUFwCBEZJsNOLach/exec";

    // ===== Data =====
    const savings = {{
      Lala: ['PNB Savings','UB Payroll','BDO Commission','GCASH (Digital pocket)','Paymaya (Digital pocket)','SeaBank (Digital Pocket)','CIMB','UNO Digital','BPI joint','Cash'],
      Ian:  ['UB Payroll','BDO Commission','GCASH (digital pocket)','BPI individual','PNB Savings','CIMB','BPI joint','Cash']
    }};
    const creditCards = {{
      Lala: ['PNB Ze-Lo','UB Basic Blue','UB Gold Go Rewards','UB Platinum','BDO Visa Classic'],
      Ian:  ['BPI Blue','BPI Gold','UB Platinum']
    }};
    const investAccounts = ['IBKR','GoTrade','PSE'];

    // ===== DOM =====
    const whoEl = document.getElementById('who');
    const categoryEl = document.getElementById('category');
    const statusEl = document.getElementById('status');
    const form = document.getElementById('trackerForm');

    // Income
    const incomeGroup = document.getElementById('incomeGroup');
    const incomeAccountEl = document.getElementById('incomeAccount');

    // Expense
    const expenseGroup = document.getElementById('expenseGroup');
    const expenseFromEl = document.getElementById('expenseFrom');

    // Transfers
    const transfersGroup = document.getElementById('transfersGroup');
    const transferTypeEl = document.getElementById('transferType');
    const trFromWhoEl = document.getElementById('trFromWho');
    const trFromAccountEl = document.getElementById('trFromAccount');
    const trToWhoEl = document.getElementById('trToWho');
    const trToAccountEl = document.getElementById('trToAccount');

    // Investment
    const investmentGroup = document.getElementById('investmentGroup');
    const invFromWhoEl = document.getElementById('invFromWho');
    const invFromAccountEl = document.getElementById('invFromAccount');
    const invToAccountEl = document.getElementById('invToAccount');

    // Giving
    const givingGroup = document.getElementById('givingGroup');
    const givingFromWhoEl = document.getElementById('givingFromWho');
    const givingFromAccountEl = document.getElementById('givingFromAccount');

    // ===== Helpers =====
    function clearOptions(sel) {{
      while (sel.options.length > 1) sel.remove(1);
    }}

    function fillSavings(sel, who) {{
      clearOptions(sel);
      if (!who) return;
      (savings[who] || []).forEach(acc => {{
        const o = document.createElement('option');
        o.text = acc; o.value = acc;
        sel.add(o);
      }});
    }}

    function fillPaidFrom(sel, who) {{
      sel.innerHTML = '<option value="">-- Select --</option>';
      if (!who) return;
      const grp1 = document.createElement('optgroup');
      grp1.label = who + ' — Savings & Wallets';
      (savings[who] || []).forEach(acc => {{
        const o = document.createElement('option'); o.text = acc; o.value = acc; grp1.appendChild(o);
      }});
      const grp2 = document.createElement('optgroup');
      grp2.label = who + ' — Credit Cards';
      (creditCards[who] || []).forEach(acc => {{
        const o = document.createElement('option'); o.text = acc; o.value = acc; grp2.appendChild(o);
      }});
      sel.appendChild(grp1);
      sel.appendChild(grp2);
    }}

    function fillInvestDest(sel) {{
      clearOptions(sel);
      investAccounts.forEach(acc => {{
        const o = document.createElement('option'); o.text = acc; o.value = acc; sel.add(o);
      }});
    }}

    function setStatus(msg, ok=true) {{
      statusEl.textContent = msg;
      statusEl.classList.remove('hidden','success','error');
      statusEl.classList.add('banner', ok ? 'success' : 'error');
    }}

    function showOnly(...els) {{
      [incomeGroup, expenseGroup, transfersGroup, investmentGroup, givingGroup]
        .forEach(el => el.classList.add('hidden'));
      els.forEach(el => el.classList.remove('hidden'));
    }}

    // ===== Wiring =====
    categoryEl.addEventListener('change', () => {{
      const v = categoryEl.value;
      if (v === 'income') showOnly(incomeGroup);
      else if (v === 'expense') showOnly(expenseGroup);
      else if (v === 'transfers') showOnly(transfersGroup);
      else if (v === 'investment') showOnly(investmentGroup);
      else if (v === 'giving') showOnly(givingGroup);
      else showOnly();
    }});

    whoEl.addEventListener('change', () => {{
      const who = whoEl.value;
      fillSavings(incomeAccountEl, who);
      fillPaidFrom(expenseFromEl, who);
    }});

    // Transfers logic
    trFromWhoEl.addEventListener('change', () => {{
      const who = trFromWhoEl.value;
      fillSavings(trFromAccountEl, who);
      if (transferTypeEl.value === 'withdrawal') {{
        trToWhoEl.value = who;
        trToWhoEl.disabled = true;
        trToAccountEl.innerHTML = '<option value="">-- Select --</option>';
        const o = document.createElement('option'); o.text = 'Cash'; o.value = 'Cash'; trToAccountEl.add(o);
        trToAccountEl.value = 'Cash';
        trToAccountEl.disabled = true;
      }} else {{
        trToWhoEl.disabled = false;
        trToAccountEl.disabled = false;
        trToAccountEl.innerHTML = '<option value="">-- Select --</option>';
      }}
    }});

    trToWhoEl.addEventListener('change', () => {{
      if (!trToWhoEl.value) return;
      fillSavings(trToAccountEl, trToWhoEl.value);
    }});

    transferTypeEl.addEventListener('change', () => {{
      const type = transferTypeEl.value;
      if (type === 'withdrawal') {{
        // Lock destination to Cash under the same person
        const who = trFromWhoEl.value;
        if (who) {{
          trToWhoEl.value = who;
        }}
        trToWhoEl.disabled = true;
        trToAccountEl.innerHTML = '<option value="">-- Select --</option>';
        const o = document.createElement('option'); o.text = 'Cash'; o.value = 'Cash'; trToAccountEl.add(o);
        trToAccountEl.value = 'Cash';
        trToAccountEl.disabled = true;
      }} else if (type === 'fund') {{
        trToWhoEl.disabled = false;
        trToAccountEl.disabled = false;
        trToAccountEl.innerHTML = '<option value="">-- Select --</option>';
        if (trToWhoEl.value) fillSavings(trToAccountEl, trToWhoEl.value);
      }} else {{
        trToWhoEl.disabled = false;
        trToAccountEl.disabled = false;
      }}
    }});

    // Investment wiring
    invFromWhoEl.addEventListener('change', () => {{
      fillSavings(invFromAccountEl, invFromWhoEl.value);
    }});
    fillInvestDest(invToAccountEl);

    // Giving wiring
    givingFromWhoEl.addEventListener('change', () => {{
      fillSavings(givingFromAccountEl, givingFromWhoEl.value);
    }});

    // Reset button
    document.getElementById('resetBtn').addEventListener('click', () => {{
      form.reset();
      showOnly();
      statusEl.classList.add('hidden');
      statusEl.textContent = '';
      // clear dynamic selects
      clearOptions(incomeAccountEl);
      expenseFromEl.innerHTML = '<option value="">-- Select --</option>';
      clearOptions(trFromAccountEl); clearOptions(trToAccountEl);
    }});

    // Submit
    form.addEventListener('submit', async (e) => {{
      e.preventDefault();
      const who = whoEl.value;
      const cat = categoryEl.value;
      if (!who || !cat) {{ setStatus('Please select "Who" and "Category".', false); return; }}

      const reqIds = [];
      function need(id) {{ const el = document.getElementById(id); if (!el || !el.value) reqIds.push(id); }}

      if (cat === 'income') {{
        ['incomeType','incomeAccount','incomeAmount'].forEach(need);
      }} else if (cat === 'expense') {{
        ['expenseCategory','expenseFrom','expenseAmount'].forEach(need);
      }} else if (cat === 'transfers') {{
        ['transferType','trFromWho','trFromAccount','trAmount'].forEach(need);
        if (document.getElementById('transferType').value === 'fund') {{
          ['trToWho','trToAccount'].forEach(need);
        }} else if (document.getElementById('transferType').value === 'withdrawal') {{
          // To will be auto-set to Cash; still ensure values exist
          ['trToWho','trToAccount'].forEach(need);
        }}
      }} else if (cat === 'investment') {{
        ['invFromWho','invFromAccount','invToAccount'].forEach(need);
      }} else if (cat === 'giving') {{
        ['givingFromWho','givingFromAccount','givingPurpose','givingAmount'].forEach(need);
      }}

      if (reqIds.length) {{
        setStatus('Please complete all required fields.', false);
        const first = document.getElementById(reqIds[0]); if (first) first.focus();
        return;
      }}

      document.getElementById('localTimestamp').value = new Date().toISOString();
      const payload = Object.fromEntries(new FormData(form).entries());
      payload.path = cat;
      payload.submitter = who;

      try {{
        setStatus('Submitting…', true);
        await fetch(SCRIPT_URL, {{
          method: 'POST',
          mode: 'no-cors',
          headers: {{ 'Content-Type': 'application/json' }},
          body: JSON.stringify(payload)
        }});
        setStatus('Saved! Row appended in Google Sheet.', true);
        form.reset();
        showOnly();
      }} catch (err) {{
        console.error(err);
        setStatus('Failed to submit. Check your Web App URL and permissions.', false);
      }}
    }});
  </script>
</body>
</html>
